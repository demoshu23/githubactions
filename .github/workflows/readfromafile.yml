# name: read repos from a file

# on:
#   push:
#     branches:
#       - main
#   schedule:
#     - cron: "0 2 * * 0" # Weekly Sunday 02:00 UTC
#   workflow_dispatch:
#     inputs:
#       dry_run:
#         description: "Dry run (no branches will be deleted)"
#         required: false
#         default: "true"

# jobs:
#   cleanup:
#     runs-on: self-hosted

#     env:
#       OWNER: demoshu23
#       STALE_DAYS: 90
#       DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
#       GITHUB_TOKEN: ${{ secrets.CLEANUP_TOKEN }}

#     steps:
#     #   - name: Install dependencies
#     #     run: |
#     #       sudo apt-get update
#     #       sudo apt-get install -y jq curl

#       - name: Validate GitHub token
#         run: |
#           curl -s \
#             -H "Authorization: token $GITHUB_TOKEN" \
#             https://api.github.com/user | jq -e '.login' >/dev/null \
#             || { echo "❌ Invalid GitHub token"; exit 1; }

#       - name: Cleanup stale branches
#         run: |
#           set -euo pipefail

#           REPO_FILE="config/target-repos.txt"
#           REPORT="readFromAFIle.csv"
#           echo "# Generated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > "$REPORT"
#           echo "repository,branch,days_old,action" >> "$REPORT"

#           NOW=$(date +%s)

#           if [ ! -f "$REPO_FILE" ]; then
#             echo "❌ Repo list file not found: $REPO_FILE"
#             exit 1
#           fi

#           echo "Dry-run mode: $DRY_RUN"
#           echo "Processing repositories from $REPO_FILE"
#           cat "$REPO_FILE"

#           while read -r REPO || [ -n "$REPO" ]; do
#             # Skip empty lines and comments
#             [[ -z "$REPO" || "$REPO" =~ ^# ]] && continue

#             FULL_REPO="$OWNER/$REPO"
#             echo "Processing $FULL_REPO"

#             BRANCHES=$(curl -s \
#               -H "Authorization: token $GITHUB_TOKEN" \
#               -H "Accept: application/vnd.github+json" \
#               "https://api.github.com/repos/$FULL_REPO/branches?per_page=100")

#             if ! echo "$BRANCHES" | jq -e 'type=="array"' >/dev/null; then
#               echo "❌ Failed to fetch branches for $FULL_REPO"
#               echo "$BRANCHES" | jq .
#               continue
#             fi

#             echo "$BRANCHES" | jq -c '.[]' | while read -r branch; do
#               BRANCH_NAME=$(echo "$branch" | jq -r '.name')

#               # Never touch protected branches
#               case "$BRANCH_NAME" in
#                 main|master|develop|release/*) continue ;;
#               esac

#               COMMIT_URL=$(echo "$branch" | jq -r '.commit.url')
#               COMMIT_DATE=$(curl -s \
#                 -H "Authorization: token $GITHUB_TOKEN" \
#                 "$COMMIT_URL" | jq -r '.commit.author.date')

#               COMMIT_TS=$(date -d "$COMMIT_DATE" +%s)
#               AGE_DAYS=$(( (NOW - COMMIT_TS) / 86400 ))

#               if [ "$AGE_DAYS" -ge "$STALE_DAYS" ]; then
#                 if [ "$DRY_RUN" = "true" ]; then
#                   echo "[DRY-RUN] $FULL_REPO:$BRANCH_NAME ($AGE_DAYS days old)"
#                   ACTION="dry-run"
#                 else
#                   echo "Deleting $FULL_REPO:$BRANCH_NAME ($AGE_DAYS days old)"
#                   STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
#                     -X DELETE \
#                     -H "Authorization: token $GITHUB_TOKEN" \
#                     "https://api.github.com/repos/$FULL_REPO/git/refs/heads/$BRANCH_NAME")

#                   [[ "$STATUS" -eq 204 ]] && ACTION="deleted" || ACTION="failed"
#                 fi

#                 echo "$FULL_REPO,$BRANCH_NAME,$AGE_DAYS,$ACTION" >> "$REPORT"
#               fi
#             done
#           done < "$REPO_FILE"

#       - name: Set timestamp
#         id: timestamp
#         run: |
#           echo "ts=$(date '+%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

#       - name: Upload cleanup report
#         uses: actions/upload-artifact@v4
#         with:
#           name: readFromAFIle-${{ steps.timestamp.outputs.ts }}
#           path: readFromAFIle.csv

#     #   - name: Send Slack notification
#     #     if: always()
#     #     env:
#     #       SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#     #     run: |
#     #       REPORT_SUMMARY=$(tail -n +3 readFromAFIle.csv | awk -F',' '{print $1" "$2" "$3" days -> "$4}' | paste -sd '\n' -)
#     #       REPORT_SUMMARY=${REPORT_SUMMARY:-"No branches deleted or eligible"}
#     #       PAYLOAD=$(jq -n --arg text "Stale Branch Cleanup Report for $OWNER (Dry-run: $DRY_RUN)\n$REPORT_SUMMARY" '{text: $text}')
#     #       curl -s -X POST -H 'Content-type: application/json' --data "$PAYLOAD" $SLACK_WEBHOOK_URL

#       - name: Send Email Notification
#         if: always()
#         uses: dawidd6/action-send-mail@v3
#         with:
#           server_address: smtp.example.com
#           server_port: 587
#           username: ${{ secrets.SMTP_USER }}
#           password: ${{ secrets.SMTP_PASS }}
#           subject: "Stale Branch Cleanup Report ($OWNER) - ${{ steps.timestamp.outputs.ts }}"
#           body: |
#             Hello Team,

#             The stale branch cleanup for organization $OWNER has completed.

#             Dry-run: $DRY_RUN
#             Report:
#             $(cat readFromAFIle.csv)

#             Regards,
#             GitHub Actions
#           to: insuretrust0@gmail.com
#           from: github-actions@example.com

name: Stale Branch Cleanup from file

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 2 * * 0" # Weekly Sunday 02:00 UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no branches will be deleted)"
        required: false
        default: "true"

jobs:
  cleanup:
    runs-on: self-hosted
    env:
      OWNER: demoshu23
      STALE_DAYS: 90
      GITHUB_TOKEN: ${{ secrets.CLEANUP_TOKEN }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Validate GitHub token
        run: |
          curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user \
            | jq -e '.login' >/dev/null || { echo "❌ Invalid GitHub token"; exit 1; }

      - name: Set timestamp
        id: timestamp
        run: |
          echo "ts=$(date '+%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Read target repositories
        id: read_repos
        run: |
          REPO_FILE="config/target-repos.txt"
          if [ -f "$REPO_FILE" ]; then
            TARGET_REPOS=$(grep -v '^#' "$REPO_FILE" | grep -v '^$')
            echo "Found repositories in $REPO_FILE"
          else
            echo "⚠ Repo list file not found, using default list"
            TARGET_REPOS="MavenHelloWorld Lab githubactions"
          fi
          echo "repos=$TARGET_REPOS" >> $GITHUB_OUTPUT

      - name: Cleanup stale branches
        run: |
          set -euo pipefail

          DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          NOW=$(date +%s)
          REPORT="stalebranchreports-${{ steps.timestamp.outputs.ts }}.csv"
          echo "repository,branch,days_old,action" > "$REPORT"
          echo "Dry-run mode: $DRY_RUN"

          for REPO in ${{ steps.read_repos.outputs.repos }}; do
            FULL_REPO="$OWNER/$REPO"
            echo "Processing $FULL_REPO"

            BRANCHES=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$FULL_REPO/branches?per_page=100")

            if ! echo "$BRANCHES" | jq -e 'type=="array"' >/dev/null; then
              echo "❌ Failed to fetch branches for $FULL_REPO"
              echo "$BRANCHES" | jq .
              continue
            fi

            echo "$BRANCHES" | jq -c '.[]' | while read -r branch; do
              BRANCH_NAME=$(echo "$branch" | jq -r '.name')

              # Skip protected branches
              case "$BRANCH_NAME" in
                main|master|develop|release/*) continue ;;
              esac

              COMMIT_URL=$(echo "$branch" | jq -r '.commit.url')
              COMMIT_DATE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$COMMIT_URL" \
                | jq -r '.commit.author.date')

              COMMIT_TS=$(date -d "$COMMIT_DATE" +%s)
              AGE_DAYS=$(( (NOW - COMMIT_TS) / 86400 ))

              if [ "$AGE_DAYS" -ge "$STALE_DAYS" ]; then
                if [ "$DRY_RUN" = "true" ]; then
                  echo "[DRY-RUN] $FULL_REPO:$BRANCH_NAME ($AGE_DAYS days old)"
                  ACTION="dry-run"
                else
                  echo "Deleting $FULL_REPO:$BRANCH_NAME ($AGE_DAYS days old)"
                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
                    -H "Authorization: token $GITHUB_TOKEN" \
                    "https://api.github.com/repos/$FULL_REPO/git/refs/heads/$BRANCH_NAME")
                  [[ "$STATUS" -eq 204 ]] && ACTION="deleted" || ACTION="failed"
                fi

                echo "$FULL_REPO,$BRANCH_NAME,$AGE_DAYS,$ACTION" >> "$REPORT"
              fi
            done
          done

      - name: Upload cleanup report
        uses: actions/upload-artifact@v4
        with:
          name: stalebranchreports-${{ steps.timestamp.outputs.ts }}
          path: stalebranchreports-${{ steps.timestamp.outputs.ts }}.csv

      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_APP_PASS }}
          subject: "Stale Branch Cleanup Report ($OWNER) - ${{ steps.timestamp.outputs.ts }}"
          body: |
            Hello,

            The stale branch cleanup for organization $OWNER has completed.

            Dry-run: $DRY_RUN

            Report:
            $(cat stalebranchreports-${{ steps.timestamp.outputs.ts }}.csv)

            Regards,
            GitHub Actions
          to: insuretrust0@gmail.com
          from: insuretrust0@gmail.com

