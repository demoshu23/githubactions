# # .github/workflows/cleanup-stale-branches.yml
# name: Cleanup stale branches (2 repos)

# on:
#   schedule:
#     - cron: '0 3 * * 0' # weekly
#   workflow_dispatch:

# jobs:
#   cleanup:
#     runs-on: ubuntu-latest

#     permissions:
#       contents: write

#     steps:
#       - name: Cleanup stale branches
#         env:
#           GH_TOKEN: ${{ secrets.CLEANUP_TOKEN }}
#         run: |
#           set -e

#           REPOS=(
#             "https://github.com/demoshu23/MavenHelloWorld"
#             "https://github.com/demoshu23/Lab"
#           )

#           DAYS=90
#           CUTOFF=$(date -d "-$DAYS days" +%s)

#           for REPO in "${REPOS[@]}"; do
#             echo "üîç Processing $REPO"

#             gh api repos/$REPO/branches --paginate \
#               | jq -r '.[].name' \
#               | grep -vE '^(main|master|develop|release/)' \
#               | while read BRANCH; do

#                   LAST_COMMIT_DATE=$(gh api repos/$REPO/commits/$BRANCH \
#                     | jq -r '.commit.committer.date')

#                   LAST_TS=$(date -d "$LAST_COMMIT_DATE" +%s)

#                   if [ "$LAST_TS" -lt "$CUTOFF" ]; then
#                     echo "üßπ Deleting $REPO:$BRANCH"
#                     gh api -X DELETE repos/$REPO/git/refs/heads/$BRANCH || true
#                   fi
#               done
#           done
# .github/workflows/cleanup-stale-branches.yml
name: Cleanup stale branches (5 repos)

on:
  schedule:
    - cron: '0 3 * * 0' # weekly
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  cleanup:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Cleanup stale branches
        env:
          # CLEANUP_TOKEN: ${{ secrets.CLEANUP_TOKEN }} #updated token
          GH_TOKEN: ${{ github.token }}
          DRY_RUN: "true"   # üîÅ set to "false" to actually delete
        run: |
          set -e

          REPOS=(
            "https://github.com/demoshu23/MavenHelloWorld"  
             env:
                GH_TOKEN: ${{ github.token }}          
            "https://github.com/demoshu23/Lab"
          )

          DAYS=90
          CUTOFF=$(date -d "-$DAYS days" +%s)

          for REPO in "${REPOS[@]}"; do
            echo "üîç Processing $REPO"

            gh api repos/$REPO/branches --paginate \
              | jq -r '.[].name' \
              | grep -vE '^(main|master|develop|release/)' \
              | while read BRANCH; do

                  LAST_COMMIT_DATE=$(gh api repos/$REPO/commits/$BRANCH \
                    | jq -r '.commit.committer.date')

                  LAST_TS=$(date -d "$LAST_COMMIT_DATE" +%s)

                  if [ "$LAST_TS" -lt "$CUTOFF" ]; then
                    if [ "$DRY_RUN" = "true" ]; then
                      echo "üß™ [DRY-RUN] Would delete $REPO:$BRANCH"
                    else
                      echo "üßπ Deleting $REPO:$BRANCH"
                      gh api -X DELETE repos/$REPO/git/refs/heads/$BRANCH || true
                    fi
                  fi
              done
          done
