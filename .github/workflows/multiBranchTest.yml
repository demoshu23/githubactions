name: Cleanup stale branches (org-wide)

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"  # Every Sunday at 03:00 UTC

permissions:
  contents: write      # Required to delete branches
  pull-requests: read  # Required to query open PRs

jobs:
  cleanup:
    runs-on: [self-hosted, dev-agentpool]  # Can also use ubuntu-latest

    env:
      ORG: demoshu23     # GitHub org
      DAYS_OLD: 90            # Threshold in days
      DRY_RUN: true           # true = log only, false = actually delete

    steps:
    - name: Verify runner environment
      run: |
        echo "Runner: $(hostname)"
        gh --version
        jq --version

    - name: Cleanup stale branches across org
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail

        # Regex for branches to skip
        PROTECTED_REGEX="^(main|master|develop/)"

        # Cutoff timestamp
        CUTOFF_TS=$(date -d "-$DAYS_OLD days" +%s)

        echo "üîç Cleaning branches older than $DAYS_OLD days"
        echo "üß™ Dry-run mode: $DRY_RUN"
        echo ""

        # List all repos in the org
        gh repo list "$ORG" --limit 1000 --json nameWithOwner --jq '.[].nameWithOwner' |
        while read -r REPO; do
          echo "üì¶ Repository: $REPO"

          # List branches in the repo
          gh api repos/$REPO/branches --paginate |
          jq -r '.[].name' |
          while read -r BRANCH; do

            # Skip protected branches
            if [[ "$BRANCH" =~ $PROTECTED_REGEX ]]; then
              echo "  ‚è≠Ô∏è  Protected: $BRANCH"
              continue
            fi

            # Skip branches with active PRs
            PR_COUNT=$(gh api \
              repos/$REPO/pulls \
              -f state=open \
              -f head="${REPO#*/}:$BRANCH" \
              --jq 'length' || echo 0)

            if [[ "$PR_COUNT" -gt 0 ]]; then
              echo "  üîí Has open PR: $BRANCH"
              continue
            fi

            # Get last commit date
            LAST_COMMIT_DATE=$(gh api \
              repos/$REPO/commits/$BRANCH \
              --jq '.commit.committer.date' 2>/dev/null || true)

            [[ -z "$LAST_COMMIT_DATE" ]] && continue

            LAST_TS=$(date -d "$LAST_COMMIT_DATE" +%s)

            # Determine if branch is stale
            if [[ "$LAST_TS" -lt "$CUTOFF_TS" ]]; then
              echo "  üóëÔ∏è  Stale branch: $BRANCH (last updated $LAST_COMMIT_DATE)"

              if [[ "$DRY_RUN" != "true" ]]; then
                # Delete branch via API
                gh api \
                  -X DELETE \
                  repos/$REPO/git/refs/heads/$BRANCH
                echo "    ‚úÖ Deleted: $BRANCH"
              else
                echo "    üß™ Dry-run: would delete $BRANCH"
              fi
            else
              echo "  ‚úÖ Recent: $BRANCH"
            fi
          done

          echo ""
        done
